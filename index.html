<!DOCTYPE html>
<html>
<head>
    <title>Portland Cyclist and Pedestrian Crashes</title>
    <meta charset="utf-8" />
	<link rel="stylesheet" href="node_modules/leaflet/dist/leaflet.css" />
	<script src="node_modules/leaflet/dist/leaflet-src.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" href="screen.css" />
	<link rel="stylesheet" href="legend.css" />
	<link rel="stylesheet" href="node_modules/leaflet.markercluster/dist/MarkerCluster.css" />
	<link rel="stylesheet" href="node_modules/leaflet.markercluster/dist/MarkerCluster.Default.css" />
	<script src="node_modules/leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>

</head>

<body>

<div id="mapid"></div>

<script>

const categories = [
	['killed', '#ff0000'],
	['seriously injured', '#0000ff'],
	['injured', '#00ff00'],
	['possibly injured', '#0080A0'],
	['no injury reported', '#A0A0A0']
];

const colors = ['#ff0000', '#0000ff', '#00ff00', '#007878', '#808080']; // Corresponding colors

var getcategory = function (feature) {
    if (Number(feature.properties["K - Fatalities Count"]) > 0) {
        return categories[0]
    }
    else if (Number(feature.properties["A - Suspected Serious Injury Count"]) > 0) {
        return categories[1]
    }
    else if (Number(feature.properties["B - Suspected Minor Injuries Count"]) > 0) {
        return categories[2]
    }
    else if (Number(feature.properties["C - Possible Injuries Count"]) > 0) {
        return categories[3]
    }
    else {
    	return categories[4]
    }
}

var getlabel = function (feature) {
    var retstr = "DOT ID: " + feature.properties["MDOT ID"] +
        ", date: " +
        feature.properties["Crash Date"]
    if ( feature.properties["Bicycle Yes/No"] == "Y" ) {
        retstr += "\nCyclist: "
    }
    else if ( feature.properties["Pedestrian Yes/No"] == "Y" ) {
        retstr += "\nPedestrian: "
    }
    retstr += getcategory(feature)[0] +
    "\nDriver action reported: " +
    feature.properties["Driver Action 1 Unit 1 Description"];
    return retstr
}

const circleMarkerStyle = {
    radius: 8,
    fillColor: '#000000',
    color: '#000',
    weight: 1,
    opacity: 1,
    fillOpacity: 0.8
}

var getMarker = function (feature, latlng) {
    var localStyle = circleMarkerStyle;
	localStyle.fillColor = getcategory(feature)[1];
    return L.circleMarker(latlng, localStyle);
}

console.log("Entered crash_map");
// 1. Initialize the map
const map = L.map('mapid').setView([43.65734974239763, -70.26189624400604], 15);
console.log("Created map");

// Add a tile layer (OpenStreetMap)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© [OpenStreetMap]() contributors'
}).addTo(map);

// Create legend
var legend = L.control({position: 'topright'});

legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend');
    var labels = ['<strong>Categories</strong>'];

    for (var i = 0; i < categories.length; i++) {
        div.innerHTML += labels.push(
            '<i style="background:' + categories[i][1] + '"></i> ' +
				categories[i][0]
        );
    }
    div.innerHTML = labels.join('<br>');
    return div;
};

legend.addTo(map);

// Create a Marker Cluster Group
var markers = L.markerClusterGroup();
console.log("Created markers");

// Fetch the remote data
fetch('all_crashes.geojson')
    .then(response => response.json())
    .then(data => {
        // 3. Process and add markers using L.geoJSON
        L.geoJSON(data, {
            onEachFeature: function (feature, layer) {
                layer.bindPopup(
                    getlabel(feature)
                )
            },
            pointToLayer(feature, latlng) {
                return getMarker(feature, latlng)
            }
        }).addTo(markers);
   }).catch(error => {
        console.error('Error fetching data:', error);
   });
map.addLayer(markers);

</script>

</body>

</html>
